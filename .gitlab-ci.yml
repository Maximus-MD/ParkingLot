stages:
  - build
  - test
  - analyze
  - deploy
  - docker

variables:
  MAVEN_IMAGE: "maven:3.8.7-openjdk-18"
  MAVEN_CACHE_DIR: ".m2/repository"
  NEXUS_URL: "${Nexus_REPO_URL}"
  NEXUS_USER: "${Nexus_REPO_USER}" 
  NEXUS_PASSWORD: "${Nexus_REPO_PASS}"
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
  SONAR_PROJECT_KEY: "${SONAR_PROJECT_KEY}"
  GIT_DEPTH: "0"
  ARTIFACT_ID: "parkinglot"
  GROUP_ID: "com.endava.md.internship"

cache:
  paths:
    - $MAVEN_CACHE_DIR

include:
  - local: '.gitlab-ci-script.yml'

build:
  stage: build
  image: $MAVEN_IMAGE
  script:
    - echo "Building the project"
    - echo "JAVA_HOME is $JAVA_HOME"
    - ./mvnw -e -X $MAVEN_CLI_OPTS clean package
  artifacts:
    paths:
      - target/*.jar
    expire_in: 3 days

maven_test:
  stage: test
  image: $MAVEN_IMAGE
  script:
    - echo "Running tests"
    - ./mvnw clean -e -X $MAVEN_CLI_OPTS
    - ./mvnw -e -X $MAVEN_CLI_OPTS test
  dependencies:
    - build
  artifacts:
    paths:
      - target/surefire-reports
    reports:
      junit: target/surefire-reports/*.xml
    expire_in: 1 week

sonar_analyze:
  stage: analyze
  image: maven:3-eclipse-temurin-17
  variables:
    MAVEN_OPTS: "-Dsonar.projectKey=${SONAR_PROJECT_KEY} -Dsonar.host.url=${SONAR_HOST_URL} -Dsonar.token=${SONAR_TOKEN}"
  script:
    - ./mvnw $MAVEN_CLI_OPTS clean install
    - echo "Running SonarQube analysis"
    - ./mvnw $MAVEN_CLI_OPTS -X sonar:sonar -Dsonar.java.binaries=target/classes
  dependencies:
    - build

deploy_nexus:
  stage: deploy
  image: curlimages/curl:latest
  script:
    - echo "Parsing POM file..."
    - VERSION=$(grep "SNAPSHOT<\/version>" pom.xml | head -n 1 | sed 's/.*<version>\(.*\)<\/version>.*/\1/')
    - echo "Group ID $GROUP_ID"
    - echo "Artifact ID $ARTIFACT_ID"
    - echo "Version $VERSION"
    - echo "Deploying artifacts to Nexus"
    - |
      curl -v -u $NEXUS_USER:$NEXUS_PASSWORD \
      ${NEXUS_URL}/repository/maven-snapshots/${GROUP_ID//.//}/${ARTIFACT_ID}/${ARTIFACT_ID}-${VERSION}.jar \
      --upload-file target/${ARTIFACT_ID}-${VERSION}.jar
  dependencies:
    - build
  only:
    - master

trigger_docker:
  stage: docker
  trigger:
    project: tooling/docker-packing
    branch: "main"
    strategy: depend
  variables:
    GROUP_ID: "${GROUP_ID}"
    ARTIFACT_ID: "${ARTIFACT_ID}"
    VERSION: ${VERSION}


